<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StayFi - SUI Integration Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .subtitle {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .wallet-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .wallet-info {
            display: none;
        }
        
        .wallet-info.active {
            display: block;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s;
            width: 100%;
            margin-bottom: 10px;
        }
        
        button:hover {
            transform: translateY(-2px);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 600;
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .info-box {
            background: #e8f4f8;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        .nft-list {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }
        
        .nft-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }
        
        .nft-card h3 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .status.unused {
            background: #d4edda;
            color: #155724;
        }
        
        .status.used {
            background: #f8d7da;
            color: #721c24;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #f5c6cb;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #c3e6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¨ StayFi - SUI ç‰ˆæœ¬</h1>
        <p class="subtitle">Hotel Night-Pass NFT on SUI Blockchain</p>
        
        <div class="info-box">
            <strong>ğŸ“Œ èªªæ˜:</strong> é€™æ˜¯ StayFi åœ¨ SUI å€å¡Šéˆä¸Šçš„å¯¦ç¾ã€‚ä½¿ç”¨ Sui Wallet é€£æ¥ä¸¦é‘„é€ é…’åº—ä½å®¿ NFTã€‚
        </div>
        
        <!-- Wallet Connection -->
        <div class="wallet-section">
            <h2>ğŸ’¼ éŒ¢åŒ…é€£æ¥</h2>
            <button id="connectBtn" onclick="connectWallet()">é€£æ¥ Sui Wallet</button>
            
            <div id="walletInfo" class="wallet-info">
                <p><strong>åœ°å€:</strong> <span id="walletAddress"></span></p>
                <p><strong>é¤˜é¡:</strong> <span id="walletBalance"></span> SUI</p>
                <button onclick="disconnectWallet()">æ–·é–‹é€£æ¥</button>
            </div>
        </div>
        
        <!-- Mint NFT Section -->
        <div class="wallet-section">
            <h2>ğŸ« é‘„é€ é…’åº— NFT</h2>
            
            <div class="form-group">
                <label for="hotelName">é…’åº—åç¨±</label>
                <input type="text" id="hotelName" placeholder="å°åŒ—å›æ‚…é…’åº—">
            </div>
            
            <div class="form-group">
                <label for="roomType">æˆ¿å‹</label>
                <select id="roomType">
                    <option value="Standard">æ¨™æº–æˆ¿</option>
                    <option value="Deluxe">è±ªè¯æˆ¿</option>
                    <option value="Suite">å¥—æˆ¿</option>
                    <option value="Executive">è¡Œæ”¿å¥—æˆ¿</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="checkIn">å…¥ä½æ—¥æœŸ</label>
                <input type="date" id="checkIn">
            </div>
            
            <div class="form-group">
                <label for="checkOut">é€€æˆ¿æ—¥æœŸ</label>
                <input type="date" id="checkOut">
            </div>
            
            <div class="form-group">
                <label for="guestName">ä½å®¢å§“å</label>
                <input type="text" id="guestName" placeholder="ç‹å°æ˜">
            </div>
            
            <div class="form-group">
                <label for="price">åƒ¹æ ¼ (SUI)</label>
                <input type="number" id="price" step="0.01" placeholder="1.5">
            </div>
            
            <button id="mintBtn" onclick="mintNFT()" disabled>é‘„é€  NFT</button>
        </div>
        
        <!-- NFT List -->
        <div class="wallet-section">
            <h2>ğŸ“‹ æˆ‘çš„ NFT</h2>
            <button onclick="loadMyNFTs()">åˆ·æ–° NFT åˆ—è¡¨</button>
            <div id="nftList" class="nft-list"></div>
        </div>
        
        <!-- Messages -->
        <div id="messages"></div>
    </div>
    
    <script src="https://unpkg.com/@mysten/wallet-standard@0.10.0/dist/index.umd.js"></script>
    <script src="https://unpkg.com/@mysten/sui.js@0.54.0/dist/index.umd.js"></script>
    
    <script>
        // SUI Configuration
        const SUI_CONFIG = {
            network: 'testnet', // Change to 'mainnet' for production
            packageId: 'YOUR_PACKAGE_ID_HERE', // Update after deployment
            registryId: 'YOUR_REGISTRY_OBJECT_ID_HERE' // Update after deployment
        };
        
        let suiClient;
        let currentWallet = null;
        let currentAccount = null;
        
        // Initialize SUI client
        function initSuiClient() {
            const { SuiClient, getFullnodeUrl } = window['@mysten/sui.js'];
            const rpcUrl = getFullnodeUrl(SUI_CONFIG.network);
            suiClient = new SuiClient({ url: rpcUrl });
            console.log('SUI Client initialized:', rpcUrl);
        }
        
        // Connect wallet
        async function connectWallet() {
            try {
                if (!window.suiWallet) {
                    showError('è«‹å…ˆå®‰è£ Sui Wallet æ“´å±•ç¨‹å¼');
                    window.open('https://chrome.google.com/webstore/detail/sui-wallet', '_blank');
                    return;
                }
                
                showLoading('æ­£åœ¨é€£æ¥éŒ¢åŒ…...');
                
                const accounts = await window.suiWallet.requestPermissions();
                if (accounts && accounts.length > 0) {
                    currentWallet = window.suiWallet;
                    currentAccount = accounts[0];
                    
                    // Get balance
                    const balance = await suiClient.getBalance({
                        owner: currentAccount.address
                    });
                    
                    // Update UI
                    document.getElementById('walletAddress').textContent = 
                        currentAccount.address.substring(0, 10) + '...' + 
                        currentAccount.address.substring(currentAccount.address.length - 8);
                    document.getElementById('walletBalance').textContent = 
                        (parseInt(balance.totalBalance) / 1e9).toFixed(4);
                    
                    document.getElementById('connectBtn').style.display = 'none';
                    document.getElementById('walletInfo').classList.add('active');
                    document.getElementById('mintBtn').disabled = false;
                    
                    clearMessages();
                    showSuccess('éŒ¢åŒ…é€£æ¥æˆåŠŸï¼');
                    
                    // Load NFTs
                    await loadMyNFTs();
                }
            } catch (error) {
                console.error('é€£æ¥éŒ¢åŒ…å¤±æ•—:', error);
                showError('é€£æ¥éŒ¢åŒ…å¤±æ•—: ' + error.message);
            }
        }
        
        // Disconnect wallet
        function disconnectWallet() {
            currentWallet = null;
            currentAccount = null;
            document.getElementById('connectBtn').style.display = 'block';
            document.getElementById('walletInfo').classList.remove('active');
            document.getElementById('mintBtn').disabled = true;
            document.getElementById('nftList').innerHTML = '';
            showSuccess('éŒ¢åŒ…å·²æ–·é–‹é€£æ¥');
        }
        
        // Mint NFT
        async function mintNFT() {
            if (!currentAccount) {
                showError('è«‹å…ˆé€£æ¥éŒ¢åŒ…');
                return;
            }
            
            try {
                // Get form data
                const hotelName = document.getElementById('hotelName').value;
                const roomType = document.getElementById('roomType').value;
                const checkIn = new Date(document.getElementById('checkIn').value).getTime();
                const checkOut = new Date(document.getElementById('checkOut').value).getTime();
                const guestName = document.getElementById('guestName').value;
                const price = parseFloat(document.getElementById('price').value);
                
                // Validation
                if (!hotelName || !guestName || !price) {
                    showError('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½');
                    return;
                }
                
                showLoading('æ­£åœ¨é‘„é€  NFT...');
                
                const { TransactionBlock } = window['@mysten/sui.js'];
                const tx = new TransactionBlock();
                
                // Split coin for payment
                const [coin] = tx.splitCoins(tx.gas, [tx.pure(price * 1e9)]);
                
                // Call mint function
                tx.moveCall({
                    target: `${SUI_CONFIG.packageId}::hotel_nft::mint_hotel_nft`,
                    arguments: [
                        tx.object(SUI_CONFIG.registryId),
                        tx.pure(Array.from(new TextEncoder().encode(hotelName))),
                        tx.pure(Array.from(new TextEncoder().encode(roomType))),
                        tx.pure(checkIn),
                        tx.pure(checkOut),
                        tx.pure(Array.from(new TextEncoder().encode(guestName))),
                        tx.pure(Array.from(new TextEncoder().encode(`ipfs://metadata/${Date.now()}`))),
                        coin
                    ],
                });
                
                // Sign and execute
                const result = await currentWallet.signAndExecuteTransactionBlock({
                    transactionBlock: tx,
                    account: currentAccount,
                });
                
                clearMessages();
                showSuccess(`NFT é‘„é€ æˆåŠŸï¼äº¤æ˜“: ${result.digest}`);
                
                // Clear form
                document.getElementById('hotelName').value = '';
                document.getElementById('guestName').value = '';
                document.getElementById('price').value = '';
                
                // Reload NFTs
                setTimeout(() => loadMyNFTs(), 2000);
                
            } catch (error) {
                console.error('é‘„é€ å¤±æ•—:', error);
                showError('é‘„é€ å¤±æ•—: ' + error.message);
            }
        }
        
        // Load user's NFTs
        async function loadMyNFTs() {
            if (!currentAccount) {
                showError('è«‹å…ˆé€£æ¥éŒ¢åŒ…');
                return;
            }
            
            try {
                showLoading('æ­£åœ¨è¼‰å…¥ NFT...');
                
                // Get owned objects
                const objects = await suiClient.getOwnedObjects({
                    owner: currentAccount.address,
                    filter: {
                        StructType: `${SUI_CONFIG.packageId}::hotel_nft::HotelNFT`
                    },
                    options: {
                        showContent: true,
                        showDisplay: true
                    }
                });
                
                const nftList = document.getElementById('nftList');
                nftList.innerHTML = '';
                
                if (objects.data.length === 0) {
                    nftList.innerHTML = '<p style="text-align: center; color: #666;">å°šç„¡ NFT</p>';
                } else {
                    objects.data.forEach(obj => {
                        const nft = obj.data.content.fields;
                        const nftCard = createNFTCard(nft);
                        nftList.appendChild(nftCard);
                    });
                }
                
                clearMessages();
            } catch (error) {
                console.error('è¼‰å…¥ NFT å¤±æ•—:', error);
                showError('è¼‰å…¥ NFT å¤±æ•—: ' + error.message);
            }
        }
        
        // Create NFT card element
        function createNFTCard(nft) {
            const card = document.createElement('div');
            card.className = 'nft-card';
            
            const checkIn = new Date(parseInt(nft.check_in_date));
            const checkOut = new Date(parseInt(nft.check_out_date));
            
            card.innerHTML = `
                <h3>${nft.hotel_name}</h3>
                <p><strong>æˆ¿å‹:</strong> ${nft.room_type}</p>
                <p><strong>ä½å®¢:</strong> ${nft.guest_name}</p>
                <p><strong>å…¥ä½:</strong> ${checkIn.toLocaleDateString()}</p>
                <p><strong>é€€æˆ¿:</strong> ${checkOut.toLocaleDateString()}</p>
                <p><strong>åƒ¹æ ¼:</strong> ${(nft.price_paid / 1e9).toFixed(4)} SUI</p>
                <span class="status ${nft.is_used ? 'used' : 'unused'}">
                    ${nft.is_used ? 'å·²ä½¿ç”¨' : 'æœªä½¿ç”¨'}
                </span>
            `;
            
            return card;
        }
        
        // UI Helper functions
        function showLoading(message) {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = `<div class="loading">${message}</div>`;
        }
        
        function showError(message) {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = `<div class="error">${message}</div>`;
        }
        
        function showSuccess(message) {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = `<div class="success">${message}</div>`;
        }
        
        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
        }
        
        // Initialize on page load
        window.addEventListener('load', () => {
            initSuiClient();
            
            // Set default dates
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            document.getElementById('checkIn').valueAsDate = today;
            document.getElementById('checkOut').valueAsDate = tomorrow;
        });
    </script>
</body>
</html>
