<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StayFi - imToken ç°¡åŒ–æ¸¬è©¦</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-4">
    <div class="max-w-2xl w-full">
        <div class="bg-gray-800 rounded-2xl shadow-2xl p-8">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-yellow-400 mb-2">ğŸ¨ StayFi</h1>
                <p class="text-gray-400">Self Protocol æ¸¬è©¦ï¼ˆæ”¯æ´ imTokenï¼‰</p>
            </div>

            <!-- Instructions -->
            <div class="mb-8 p-6 bg-blue-900 bg-opacity-30 rounded-xl">
                <h3 class="text-xl font-bold mb-4">ğŸ“± æ¸¬è©¦èªªæ˜ï¼š</h3>
                <div class="space-y-3 text-sm">
                    <div class="flex items-start gap-3">
                        <span class="text-2xl">1ï¸âƒ£</span>
                        <div>
                            <p class="font-bold">åœ¨é›»è…¦ä¸Šé»æ“Šã€Œé€£æ¥éŒ¢åŒ…ã€</p>
                            <p class="text-gray-400">æœƒè‡ªå‹•æ‰“é–‹ MetaMask</p>
                        </div>
                    </div>
                    <div class="flex items-start gap-3">
                        <span class="text-2xl">2ï¸âƒ£</span>
                        <div>
                            <p class="font-bold">æ‰¹å‡†é€£æ¥</p>
                            <p class="text-gray-400">ç¢ºèªåˆ‡æ›åˆ° Celo Alfajores æ¸¬è©¦ç¶²</p>
                        </div>
                    </div>
                    <div class="flex items-start gap-3">
                        <span class="text-2xl">3ï¸âƒ£</span>
                        <div>
                            <p class="font-bold">é»æ“Šã€Œé–‹å§‹é©—è­‰ã€</p>
                            <p class="text-gray-400">æ¨¡æ“¬ Self Protocol èº«ä»½é©—è­‰</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status -->
            <div id="status" class="mb-6 p-4 bg-gray-700 rounded-lg text-center">
                <p class="text-lg">ğŸ”Œ æœªé€£æ¥éŒ¢åŒ…</p>
            </div>

            <!-- Buttons -->
            <div class="space-y-4">
                <!-- Connect Button -->
                <button id="connectBtn" onclick="connectWallet()" 
                    class="w-full bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-bold py-4 px-6 rounded-xl text-lg transition shadow-lg">
                    ğŸ”— é€£æ¥éŒ¢åŒ… (MetaMask)
                </button>

                <!-- Verify Button -->
                <button id="verifyBtn" onclick="startVerification()" disabled
                    class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-6 rounded-xl text-lg transition shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                    ğŸ” é–‹å§‹é©—è­‰ (Self Protocol)
                </button>

                <!-- Check Contract Button -->
                <button id="checkBtn" onclick="checkContract()" disabled
                    class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-6 rounded-xl text-lg transition shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                    ğŸ“Š æŸ¥è©¢åˆç´„ç‹€æ…‹
                </button>

                <!-- Disconnect Button -->
                <button id="disconnectBtn" onclick="disconnect()" disabled
                    class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-4 px-6 rounded-xl text-lg transition shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                    âŒ æ–·é–‹é€£æ¥
                </button>
            </div>

            <!-- Wallet Info -->
            <div id="walletInfo" class="mt-8 hidden">
                <div class="bg-gray-700 rounded-lg p-6 space-y-4">
                    <div>
                        <p class="text-gray-400 text-sm mb-1">éŒ¢åŒ…åœ°å€</p>
                        <p id="address" class="font-mono text-sm text-yellow-400 break-all"></p>
                    </div>
                    <div>
                        <p class="text-gray-400 text-sm mb-1">ç¶²è·¯</p>
                        <p id="network" class="text-green-400"></p>
                    </div>
                    <div>
                        <p class="text-gray-400 text-sm mb-1">é¤˜é¡</p>
                        <p id="balance" class="text-blue-400"></p>
                    </div>
                </div>
            </div>

            <!-- Verification Status -->
            <div id="verificationStatus" class="mt-8 hidden">
                <div class="bg-gray-700 rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-4">ğŸ” é©—è­‰ç‹€æ…‹</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center p-3 bg-gray-800 rounded">
                            <span>Age 18+</span>
                            <span id="status-age" class="text-2xl">â³</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-800 rounded">
                            <span>Not Sanctioned Country</span>
                            <span id="status-country" class="text-2xl">â³</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-800 rounded">
                            <span>OFAC Compliant</span>
                            <span id="status-ofac" class="text-2xl">â³</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contract Result -->
            <div id="contractResult" class="mt-8 hidden">
                <div class="bg-gray-700 rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-4">ğŸ“‹ åˆç´„æŸ¥è©¢çµæœ</h3>
                    <div id="contractContent" class="text-sm space-y-2"></div>
                </div>
            </div>
        </div>

        <!-- Logs -->
        <div id="logs" class="mt-4 bg-gray-800 rounded-lg p-4 max-h-64 overflow-y-auto hidden">
            <h3 class="font-bold mb-2 text-sm">ğŸ“ æ“ä½œæ—¥èªŒ</h3>
            <div id="logContent" class="text-xs text-gray-400 font-mono space-y-1"></div>
        </div>

        <!-- Alternative -->
        <div class="mt-6 p-4 bg-yellow-900 bg-opacity-30 rounded-lg text-center">
            <p class="text-sm text-yellow-200 mb-2">ğŸ’¡ <strong>çµ¦ imToken ç”¨æˆ¶ï¼š</strong></p>
            <p class="text-xs text-gray-300">
                ç”±æ–¼ WalletConnect ç›¸å®¹æ€§å•é¡Œï¼Œå»ºè­°åœ¨æ¡Œé¢ä½¿ç”¨ <strong>MetaMask</strong> å®Œæˆæ¸¬è©¦ã€‚<br>
                æˆ–è€…åœ¨ imToken çš„ <strong>DApp ç€è¦½å™¨</strong>ä¸­æ‰“é–‹æ­¤é é¢ï¼Œç„¶å¾Œé»æ“Šé€£æ¥æŒ‰éˆ•ã€‚
            </p>
        </div>
    </div>

    <script>
        // Configuration
        const CELO_ALFAJORES_CHAIN_ID = 44787;
        const CELO_ALFAJORES_HEX = '0xAEF3';
        const BACKEND_URL = 'http://localhost:3001/api/verify';
        const SELF_VERIFIER_ADDRESS = '0x0E801D84Fa97b50751Dbf25036d067dCf18858bF';

        let provider = null;
        let signer = null;
        let userAddress = null;

        // Logging
        function log(message) {
            console.log(message);
            const logDiv = document.getElementById('logContent');
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(logEntry);
            document.getElementById('logs').classList.remove('hidden');
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Update Status
        function updateStatus(message, color = 'yellow') {
            document.getElementById('status').innerHTML = 
                `<p class="text-lg text-${color}-400">${message}</p>`;
        }

        // Connect Wallet
        async function connectWallet() {
            try {
                // Check if MetaMask/Web3 provider exists
                if (typeof window.ethereum === 'undefined') {
                    alert('è«‹å®‰è£ MetaMask æˆ–åœ¨ imToken DApp ç€è¦½å™¨ä¸­æ‰“é–‹æ­¤é é¢ï¼');
                    log('âŒ æœªæª¢æ¸¬åˆ° Web3 æä¾›è€…');
                    return;
                }

                log('æ­£åœ¨é€£æ¥éŒ¢åŒ…...');
                updateStatus('ğŸ”„ æ­£åœ¨é€£æ¥...', 'blue');

                // Request account access
                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts' 
                });

                // Initialize provider
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = accounts[0];

                log(`âœ… å·²é€£æ¥: ${userAddress}`);
                updateStatus('âœ… éŒ¢åŒ…å·²é€£æ¥', 'green');

                // Display wallet info
                document.getElementById('walletInfo').classList.remove('hidden');
                document.getElementById('address').textContent = userAddress;

                // Get network info
                const network = await provider.getNetwork();
                document.getElementById('network').textContent = 
                    network.chainId === CELO_ALFAJORES_CHAIN_ID 
                        ? 'Celo Alfajores Testnet âœ…' 
                        : `Chain ID: ${network.chainId} âš ï¸`;

                // Get balance
                const balance = await provider.getBalance(userAddress);
                document.getElementById('balance').textContent = 
                    `${ethers.utils.formatEther(balance).substring(0, 8)} CELO`;

                // Check if on correct network
                if (network.chainId !== CELO_ALFAJORES_CHAIN_ID) {
                    log('âš ï¸ è«‹åˆ‡æ›åˆ° Celo Alfajores æ¸¬è©¦ç¶²');
                    if (confirm('éœ€è¦åˆ‡æ›åˆ° Celo Alfajores æ¸¬è©¦ç¶²ï¼Œæ˜¯å¦ç«‹å³åˆ‡æ›ï¼Ÿ')) {
                        await switchNetwork();
                    }
                }

                // Enable buttons
                document.getElementById('verifyBtn').disabled = false;
                document.getElementById('checkBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = false;
                document.getElementById('connectBtn').disabled = true;

            } catch (error) {
                console.error('é€£æ¥å¤±æ•—:', error);
                log(`âŒ é€£æ¥å¤±æ•—: ${error.message}`);
                updateStatus('âŒ é€£æ¥å¤±æ•—', 'red');
                alert('é€£æ¥å¤±æ•—: ' + error.message);
            }
        }

        // Switch Network
        async function switchNetwork() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: CELO_ALFAJORES_HEX }],
                });
                log('âœ… å·²åˆ‡æ›åˆ° Celo Alfajores');
            } catch (switchError) {
                if (switchError.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: CELO_ALFAJORES_HEX,
                                chainName: 'Celo Alfajores Testnet',
                                nativeCurrency: {
                                    name: 'CELO',
                                    symbol: 'CELO',
                                    decimals: 18
                                },
                                rpcUrls: ['https://alfajores-forno.celo-testnet.org'],
                                blockExplorerUrls: ['https://alfajores.celoscan.io/']
                            }],
                        });
                        log('âœ… Celo Alfajores ç¶²è·¯å·²æ·»åŠ ');
                    } catch (addError) {
                        console.error('æ·»åŠ ç¶²è·¯å¤±æ•—:', addError);
                        log(`âŒ æ·»åŠ ç¶²è·¯å¤±æ•—: ${addError.message}`);
                    }
                }
            }
        }

        // Start Verification
        async function startVerification() {
            try {
                log('ğŸ” é–‹å§‹ Self Protocol é©—è­‰...');
                document.getElementById('verificationStatus').classList.remove('hidden');
                updateStatus('ğŸ”„ æ­£åœ¨é©—è­‰...', 'blue');

                // Mock verification data
                const verificationData = {
                    attestationId: 1,
                    proof: '0x' + '00'.repeat(100),
                    publicSignals: [1, 2, 3],
                    userContextData: ethers.utils.keccak256(
                        ethers.utils.toUtf8Bytes(userAddress)
                    )
                };

                log('ç™¼é€é©—è­‰è«‹æ±‚åˆ°å¾Œç«¯...');

                // Call backend
                const response = await fetch(BACKEND_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(verificationData)
                });

                const result = await response.json();
                log(`å¾Œç«¯å›æ‡‰: ${JSON.stringify(result).substring(0, 100)}...`);

                if (result.status === 'success' || result.result === true) {
                    document.getElementById('status-age').textContent = 'âœ…';
                    document.getElementById('status-country').textContent = 'âœ…';
                    document.getElementById('status-ofac').textContent = 'âœ…';

                    updateStatus('âœ… é©—è­‰æˆåŠŸï¼', 'green');
                    log('âœ… é©—è­‰å®Œæˆï¼');

                    if (result.onchain && result.onchain.transactionHash) {
                        log(`ğŸ“ äº¤æ˜“: ${result.onchain.transactionHash}`);
                        setTimeout(() => {
                            alert(`é©—è­‰æˆåŠŸï¼\n\næŸ¥çœ‹äº¤æ˜“:\n${result.onchain.networkUrl}`);
                        }, 500);
                    } else {
                        alert('é©—è­‰æˆåŠŸï¼\nï¼ˆå¾Œç«¯è™•ç†å®Œæˆï¼Œå¯æŸ¥è©¢åˆç´„ç‹€æ…‹ï¼‰');
                    }
                } else {
                    updateStatus('âŒ é©—è­‰å¤±æ•—', 'red');
                    log(`âŒ é©—è­‰å¤±æ•—: ${result.reason || 'æœªçŸ¥éŒ¯èª¤'}`);
                    alert('é©—è­‰å¤±æ•—: ' + (result.reason || 'è«‹æª¢æŸ¥å¾Œç«¯æ—¥èªŒ'));
                }

            } catch (error) {
                console.error('é©—è­‰éŒ¯èª¤:', error);
                log(`âŒ é©—è­‰éŒ¯èª¤: ${error.message}`);
                updateStatus('âŒ é©—è­‰éŒ¯èª¤', 'red');
                alert('é©—è­‰éŒ¯èª¤: ' + error.message);
            }
        }

        // Check Contract
        async function checkContract() {
            try {
                log('ğŸ“Š æŸ¥è©¢åˆç´„ç‹€æ…‹...');
                document.getElementById('contractResult').classList.remove('hidden');
                const content = document.getElementById('contractContent');
                content.innerHTML = '<p class="text-gray-400">æ­£åœ¨æŸ¥è©¢...</p>';

                // Contract ABI
                const abi = [
                    'function isVerified(address user) view returns (bool)',
                    'function getVerification(address user) view returns (tuple(uint96 timestamp, bytes32 proofHash, bool isVerified, bool isAgeValid, bool isCountryValid, bool isOfacClear))'
                ];

                const contract = new ethers.Contract(SELF_VERIFIER_ADDRESS, abi, provider);

                // Check if verified
                const isVerified = await contract.isVerified(userAddress);
                log(`åˆç´„æŸ¥è©¢çµæœ: isVerified = ${isVerified}`);

                if (isVerified) {
                    const verification = await contract.getVerification(userAddress);
                    const timestamp = new Date(verification.timestamp * 1000);

                    content.innerHTML = `
                        <div class="space-y-2">
                            <p class="text-green-400 font-bold">âœ… å·²é©—è­‰</p>
                            <p><span class="text-gray-400">æ™‚é–“:</span> ${timestamp.toLocaleString()}</p>
                            <p><span class="text-gray-400">å¹´é½¡é©—è­‰:</span> ${verification.isAgeValid ? 'âœ…' : 'âŒ'}</p>
                            <p><span class="text-gray-400">åœ‹å®¶é©—è­‰:</span> ${verification.isCountryValid ? 'âœ…' : 'âŒ'}</p>
                            <p><span class="text-gray-400">OFACé©—è­‰:</span> ${verification.isOfacClear ? 'âœ…' : 'âŒ'}</p>
                            <p class="text-xs text-gray-500 mt-3 break-all">Proof Hash: ${verification.proofHash}</p>
                        </div>
                    `;
                    log('âœ… åˆç´„æŸ¥è©¢å®Œæˆ');
                } else {
                    content.innerHTML = '<p class="text-yellow-400">âš ï¸ å°šæœªé©—è­‰</p>';
                    log('â„¹ï¸ ç”¨æˆ¶å°šæœªå®Œæˆé©—è­‰');
                }

            } catch (error) {
                console.error('æŸ¥è©¢å¤±æ•—:', error);
                log(`âŒ æŸ¥è©¢å¤±æ•—: ${error.message}`);
                document.getElementById('contractContent').innerHTML = 
                    `<p class="text-red-400">âŒ æŸ¥è©¢å¤±æ•—: ${error.message}</p>`;
            }
        }

        // Disconnect
        function disconnect() {
            provider = null;
            signer = null;
            userAddress = null;

            document.getElementById('walletInfo').classList.add('hidden');
            document.getElementById('verificationStatus').classList.add('hidden');
            document.getElementById('contractResult').classList.add('hidden');
            
            document.getElementById('verifyBtn').disabled = true;
            document.getElementById('checkBtn').disabled = true;
            document.getElementById('disconnectBtn').disabled = true;
            document.getElementById('connectBtn').disabled = false;

            updateStatus('ğŸ”Œ æœªé€£æ¥éŒ¢åŒ…', 'yellow');
            log('å·²æ–·é–‹é€£æ¥');
        }

        // Initialize
        window.addEventListener('load', () => {
            log('é é¢å·²è¼‰å…¥');
            log(`å¾Œç«¯ API: ${BACKEND_URL}`);
            log(`åˆç´„åœ°å€: ${SELF_VERIFIER_ADDRESS}`);
        });
    </script>
</body>
</html>
