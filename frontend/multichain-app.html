<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StayFi - Multi-Chain Hotel NFT Platform</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }
        
        header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        h1 { color: #333; font-size: 2.5em; margin-bottom: 10px; }
        .subtitle { color: #667eea; font-size: 1.1em; }
        
        /* Chain Selector */
        .chain-selector {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .chain-btn {
            padding: 15px 30px;
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            cursor: pointer;
            background: white;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            font-weight: 600;
        }
        
        .chain-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .chain-btn.active { border-color: #667eea; background: #f0f4ff; }
        .chain-btn.disabled { opacity: 0.5; cursor: not-allowed; }
        .chain-icon { font-size: 24px; }
        
        /* Wallet Section */
        .wallet-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .wallet-info { display: none; }
        .wallet-info.active { display: block; }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .info-row:last-child { border-bottom: none; }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s;
            width: 100%;
            margin-top: 10px;
        }
        
        button:hover { transform: translateY(-2px); }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        /* Form Section */
        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        /* NFT Grid */
        .nft-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .nft-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s;
        }
        
        .nft-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .nft-card h3 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .nft-card p {
            margin: 8px 0;
            color: #666;
        }
        
        .badge {
            display: inline-block;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .badge.success { background: #d4edda; color: #155724; }
        .badge.warning { background: #fff3cd; color: #856404; }
        .badge.danger { background: #f8d7da; color: #721c24; }
        
        .chain-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        /* Messages */
        .message {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            display: none;
        }
        
        .message.show { display: block; }
        .message.error { background: #f8d7da; color: #721c24; }
        .message.success { background: #d4edda; color: #155724; }
        .message.info { background: #d1ecf1; color: #0c5460; }
        
        /* Feature Pills */
        .feature-pills {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        
        .pill {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            background: #e8f4f8;
            color: #0277bd;
        }
        
        .pill.disabled {
            background: #f5f5f5;
            color: #999;
            text-decoration: line-through;
        }
        
        /* Loading Spinner */
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 20px; }
            h1 { font-size: 1.8em; }
            .chain-selector { flex-direction: column; }
            .nft-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ¨ StayFi Multi-Chain</h1>
            <p class="subtitle">Hotel Night-Pass NFT Platform â€¢ Multiple Blockchains</p>
        </header>
        
        <!-- Chain Selector -->
        <div class="chain-selector" id="chainSelector"></div>
        
        <!-- Current Chain Info -->
        <div id="chainInfo" class="message info"></div>
        
        <!-- Wallet Section -->
        <div class="wallet-section">
            <h2>ğŸ’¼ éŒ¢åŒ…é€£æ¥</h2>
            <div id="walletConnect">
                <button id="connectBtn" onclick="connectWallet()">é€£æ¥éŒ¢åŒ…</button>
            </div>
            <div id="walletInfo" class="wallet-info">
                <div class="info-row">
                    <strong>åœ°å€:</strong>
                    <span id="walletAddress"></span>
                </div>
                <div class="info-row">
                    <strong>é¤˜é¡:</strong>
                    <span id="walletBalance"></span>
                </div>
                <div class="info-row">
                    <strong>ç¶²çµ¡:</strong>
                    <span id="walletNetwork"></span>
                </div>
                <button class="btn-secondary" onclick="disconnectWallet()">æ–·é–‹é€£æ¥</button>
            </div>
        </div>
        
        <!-- Mint NFT Section -->
        <div class="form-section">
            <h2>ğŸ« é‘„é€  Hotel NFT</h2>
            <div id="mintFeatureCheck"></div>
            
            <div class="form-group">
                <label for="hotelName">é…’åº—åç¨±</label>
                <input type="text" id="hotelName" placeholder="å°åŒ—å›æ‚…é…’åº—">
            </div>
            
            <div class="form-group">
                <label for="roomType">æˆ¿å‹</label>
                <select id="roomType">
                    <option value="Standard">æ¨™æº–æˆ¿</option>
                    <option value="Deluxe">è±ªè¯æˆ¿</option>
                    <option value="Suite">å¥—æˆ¿</option>
                    <option value="Executive">è¡Œæ”¿å¥—æˆ¿</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="checkIn">å…¥ä½æ—¥æœŸ</label>
                <input type="date" id="checkIn">
            </div>
            
            <div class="form-group">
                <label for="checkOut">é€€æˆ¿æ—¥æœŸ</label>
                <input type="date" id="checkOut">
            </div>
            
            <div class="form-group">
                <label for="guestName">ä½å®¢å§“å</label>
                <input type="text" id="guestName" placeholder="ç‹å°æ˜">
            </div>
            
            <div class="form-group">
                <label for="price">åƒ¹æ ¼ <span id="priceUnit"></span></label>
                <input type="number" id="price" step="0.01" placeholder="1.5">
            </div>
            
            <button id="mintBtn" onclick="mintNFT()" disabled>é‘„é€  NFT</button>
        </div>
        
        <!-- My NFTs -->
        <div class="form-section">
            <h2>ğŸ“‹ æˆ‘çš„ NFT</h2>
            <button onclick="loadMyNFTs()">åˆ·æ–° NFT åˆ—è¡¨</button>
            <div id="nftList" class="nft-grid"></div>
        </div>
        
        <!-- Messages -->
        <div id="messageArea"></div>
    </div>
    
    <!-- Dependencies -->
    <script src="multichain-config.js"></script>
    <script src="libs/multichain-wallet-adapter.js"></script>
    <script src="https://unpkg.com/@mysten/sui.js@0.54.0/dist/index.umd.js"></script>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js"></script>
    
    <script>
        // Global state
        let walletAdapter = new MultichainWalletAdapter();
        let currentChain = MULTICHAIN_CONFIG.DEFAULT_CHAIN;
        let currentContracts = null;
        
        // Initialize app
        window.addEventListener('load', () => {
            initializeChainSelector();
            updateChainInfo();
            setDefaultDates();
            
            // Set up event listeners
            walletAdapter.on('disconnected', handleDisconnect);
            walletAdapter.on('chainSwitched', handleChainSwitch);
        });
        
        // Initialize chain selector buttons
        function initializeChainSelector() {
            const selector = document.getElementById('chainSelector');
            const chains = getActiveChains();
            
            chains.forEach(chain => {
                const btn = document.createElement('button');
                btn.className = 'chain-btn';
                if (chain.id === currentChain) btn.classList.add('active');
                
                btn.innerHTML = `
                    <span class="chain-icon">${chain.icon}</span>
                    <div>
                        <div>${chain.name}</div>
                        <small style="color: #999">${chain.displayName}</small>
                    </div>
                `;
                
                btn.onclick = () => switchChain(chain.id);
                selector.appendChild(btn);
            });
        }
        
        // Switch chain
        async function switchChain(chainId) {
            if (chainId === currentChain) return;
            
            // Update UI
            document.querySelectorAll('.chain-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.chain-btn').classList.add('active');
            
            currentChain = chainId;
            updateChainInfo();
            
            // Disconnect if connected
            if (walletAdapter.isConnected()) {
                await walletAdapter.switchChain(chainId);
                disconnectWallet();
            }
        }
        
        // Update chain info display
        function updateChainInfo() {
            const chain = getChainConfig(currentChain);
            const infoDiv = document.getElementById('chainInfo');
            const priceUnit = document.getElementById('priceUnit');
            
            if (chain) {
                infoDiv.className = 'message info show';
                infoDiv.innerHTML = `
                    <strong>${chain.icon} ${chain.displayName}</strong>
                    <div class="feature-pills">
                        ${chain.features.nftMinting ? '<span class="pill">âœ“ NFT é‘„é€ </span>' : '<span class="pill disabled">NFT é‘„é€ </span>'}
                        ${chain.features.marketplace ? '<span class="pill">âœ“ å¸‚å ´äº¤æ˜“</span>' : '<span class="pill disabled">å¸‚å ´äº¤æ˜“</span>'}
                        ${chain.features.lending ? '<span class="pill">âœ“ å€Ÿè²¸</span>' : '<span class="pill disabled">å€Ÿè²¸</span>'}
                    </div>
                    <small>å¹³å‡äº¤æ˜“æ™‚é–“: ${chain.metrics.avgBlockTime} | Gas: ${chain.metrics.avgGasCost}</small>
                `;
                
                priceUnit.textContent = `(${chain.network.nativeCurrency?.symbol || chain.name})`;
            }
        }
        
        // Connect wallet
        async function connectWallet() {
            try {
                showMessage('æ­£åœ¨é€£æ¥éŒ¢åŒ…...', 'info');
                
                const chain = getChainConfig(currentChain);
                const walletId = chain.type === 'evm' ? 'metamask' : 'sui-wallet';
                
                const result = await walletAdapter.connect(currentChain, walletId);
                
                // Update UI
                document.getElementById('walletAddress').textContent = formatAddress(result.address);
                document.getElementById('walletBalance').textContent = result.balance;
                document.getElementById('walletNetwork').textContent = chain.displayName;
                
                document.getElementById('walletConnect').style.display = 'none';
                document.getElementById('walletInfo').classList.add('active');
                document.getElementById('mintBtn').disabled = false;
                
                showMessage('éŒ¢åŒ…é€£æ¥æˆåŠŸï¼', 'success');
                
                // Load NFTs
                setTimeout(() => loadMyNFTs(), 1000);
                
            } catch (error) {
                console.error('Connect error:', error);
                showMessage('é€£æ¥å¤±æ•—: ' + error.message, 'error');
            }
        }
        
        // Disconnect wallet
        function disconnectWallet() {
            walletAdapter.disconnect();
            handleDisconnect();
        }
        
        // Handle disconnect
        function handleDisconnect() {
            document.getElementById('walletConnect').style.display = 'block';
            document.getElementById('walletInfo').classList.remove('active');
            document.getElementById('mintBtn').disabled = true;
            document.getElementById('nftList').innerHTML = '';
            showMessage('éŒ¢åŒ…å·²æ–·é–‹', 'info');
        }
        
        // Handle chain switch
        function handleChainSwitch(newChainId) {
            currentChain = newChainId;
            updateChainInfo();
        }
        
        // Mint NFT
        async function mintNFT() {
            if (!walletAdapter.isConnected()) {
                showMessage('è«‹å…ˆé€£æ¥éŒ¢åŒ…', 'error');
                return;
            }
            
            // Get form data
            const hotelName = document.getElementById('hotelName').value;
            const roomType = document.getElementById('roomType').value;
            const checkIn = new Date(document.getElementById('checkIn').value).getTime();
            const checkOut = new Date(document.getElementById('checkOut').value).getTime();
            const guestName = document.getElementById('guestName').value;
            const price = document.getElementById('price').value;
            
            if (!hotelName || !guestName || !price) {
                showMessage('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½', 'error');
                return;
            }
            
            try {
                showMessage('æ­£åœ¨é‘„é€  NFT...', 'info');
                
                const chain = getChainConfig(currentChain);
                let txHash;
                
                if (chain.type === 'evm') {
                    txHash = await mintEVMNFT({hotelName, roomType, checkIn, checkOut, guestName, price});
                } else if (chain.type === 'move') {
                    txHash = await mintSuiNFT({hotelName, roomType, checkIn, checkOut, guestName, price});
                }
                
                const explorerUrl = getExplorerTxUrl(currentChain, txHash);
                showMessage(`NFT é‘„é€ æˆåŠŸï¼ <a href="${explorerUrl}" target="_blank">æŸ¥çœ‹äº¤æ˜“</a>`, 'success');
                
                // Clear form
                document.getElementById('hotelName').value = '';
                document.getElementById('guestName').value = '';
                document.getElementById('price').value = '';
                
                setTimeout(() => loadMyNFTs(), 2000);
                
            } catch (error) {
                console.error('Mint error:', error);
                showMessage('é‘„é€ å¤±æ•—: ' + error.message, 'error');
            }
        }
        
        // Mint EVM NFT (placeholder - implement based on your contract)
        async function mintEVMNFT(data) {
            showMessage('EVM NFT é‘„é€ åŠŸèƒ½æ­£åœ¨é–‹ç™¼ä¸­...', 'info');
            throw new Error('åŠŸèƒ½é–‹ç™¼ä¸­');
        }
        
        // Mint Sui NFT
        async function mintSuiNFT(data) {
            const chain = getChainConfig(currentChain);
            const { TransactionBlock } = window['@mysten/sui.js'];
            
            const tx = new TransactionBlock();
            const priceInMist = Math.floor(data.price * 1e9);
            const [coin] = tx.splitCoins(tx.gas, [tx.pure(priceInMist)]);
            
            tx.moveCall({
                target: `${chain.contracts.packageId}::hotel_nft::mint_hotel_nft`,
                arguments: [
                    tx.object(chain.contracts.registryId),
                    tx.pure(Array.from(new TextEncoder().encode(data.hotelName))),
                    tx.pure(Array.from(new TextEncoder().encode(data.roomType))),
                    tx.pure(data.checkIn),
                    tx.pure(data.checkOut),
                    tx.pure(Array.from(new TextEncoder().encode(data.guestName))),
                    tx.pure(Array.from(new TextEncoder().encode(`ipfs://metadata/${Date.now()}`))),
                    coin
                ],
            });
            
            return await walletAdapter.sendTransaction(tx);
        }
        
        // Load user's NFTs
        async function loadMyNFTs() {
            if (!walletAdapter.isConnected()) {
                showMessage('è«‹å…ˆé€£æ¥éŒ¢åŒ…', 'error');
                return;
            }
            
            const nftList = document.getElementById('nftList');
            nftList.innerHTML = '<div class="loading"><div class="spinner"></div>æ­£åœ¨è¼‰å…¥ NFT...</div>';
            
            try {
                const chain = getChainConfig(currentChain);
                let nfts = [];
                
                if (chain.type === 'move') {
                    nfts = await loadSuiNFTs();
                }
                
                nftList.innerHTML = '';
                
                if (nfts.length === 0) {
                    nftList.innerHTML = '<p style="text-align: center; color: #999; grid-column: 1/-1;">å°šç„¡ NFT</p>';
                } else {
                    nfts.forEach(nft => {
                        const card = createNFTCard(nft);
                        nftList.appendChild(card);
                    });
                }
                
            } catch (error) {
                console.error('Load NFTs error:', error);
                nftList.innerHTML = '<p style="text-align: center; color: #f44336;">è¼‰å…¥å¤±æ•—</p>';
            }
        }
        
        // Load Sui NFTs
        async function loadSuiNFTs() {
            const chain = getChainConfig(currentChain);
            const address = walletAdapter.getAddress();
            
            const { SuiClient, getFullnodeUrl } = window['@mysten/sui.js'];
            const client = new SuiClient({ url: getFullnodeUrl(chain.network.name) });
            
            const objects = await client.getOwnedObjects({
                owner: address,
                filter: {
                    StructType: `${chain.contracts.packageId}::hotel_nft::HotelNFT`
                },
                options: {
                    showContent: true
                }
            });
            
            return objects.data.map(obj => obj.data.content.fields);
        }
        
        // Create NFT card
        function createNFTCard(nft) {
            const card = document.createElement('div');
            card.className = 'nft-card';
            
            const chain = getChainConfig(currentChain);
            const checkIn = new Date(parseInt(nft.check_in_date || nft.checkInDate));
            const checkOut = new Date(parseInt(nft.check_out_date || nft.checkOutDate));
            
            card.innerHTML = `
                <h3>${nft.hotel_name || nft.hotelName}</h3>
                <span class="chain-badge" style="background: ${chain.color}20; color: ${chain.color}">
                    ${chain.icon} ${chain.name}
                </span>
                <p><strong>æˆ¿å‹:</strong> ${nft.room_type || nft.roomType}</p>
                <p><strong>ä½å®¢:</strong> ${nft.guest_name || nft.guestName}</p>
                <p><strong>å…¥ä½:</strong> ${checkIn.toLocaleDateString()}</p>
                <p><strong>é€€æˆ¿:</strong> ${checkOut.toLocaleDateString()}</p>
                <span class="badge ${(nft.is_used || nft.isUsed) ? 'danger' : 'success'}">
                    ${(nft.is_used || nft.isUsed) ? 'å·²ä½¿ç”¨' : 'æœªä½¿ç”¨'}
                </span>
            `;
            
            return card;
        }
        
        // Show message
        function showMessage(text, type) {
            const area = document.getElementById('messageArea');
            const msg = document.createElement('div');
            msg.className = `message ${type} show`;
            msg.innerHTML = text;
            area.appendChild(msg);
            
            setTimeout(() => {
                msg.classList.remove('show');
                setTimeout(() => msg.remove(), 300);
            }, 5000);
        }
        
        // Set default dates
        function setDefaultDates() {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            document.getElementById('checkIn').valueAsDate = today;
            document.getElementById('checkOut').valueAsDate = tomorrow;
        }
    </script>
</body>
</html>
