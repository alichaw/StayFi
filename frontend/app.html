<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StayFi - RWA on Blockchain</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js" type="text/javascript"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            display: inline-block;
            width: 56px;
            height: 56px;
            border: 6px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #EAB308;
            animation: spin 1s ease-in-out infinite;
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-dark': '#1E293B',
                        'primary-gold': '#EAB308',
                        'primary-bg': '#F8FAFC',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-300 min-h-screen flex items-center justify-center p-4 font-sans">

    <!-- App Container -->
    <div id="app-container" class="relative w-[390px] h-[844px] bg-primary-bg shadow-2xl rounded-[44px] overflow-hidden border-8 border-black">

        <!-- Wallet Connect Screen -->
        <div id="screen-wallet-connect" class="screen absolute inset-0 bg-primary-dark text-white p-8 flex flex-col justify-between">
            <div class="text-center mt-16 animate-fade-in">
                <svg class="w-20 h-20 mx-auto" viewBox="0 0 24 24" fill="none">
                    <path d="M12 2L2 7V17L12 22L22 17V7L12 2Z" stroke="#EAB308" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M2 7L12 12L22 7" stroke="#EAB308" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12 12V22" stroke="#EAB308" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <h1 class="text-4xl font-bold mt-4 text-primary-gold">StayFi</h1>
                <p class="text-lg text-gray-300 mt-2">Own Your Night on Blockchain</p>
            </div>

            <div class="flex flex-col gap-6 animate-fade-in">
                <div id="wallet-info" class="hidden bg-gray-800 rounded-lg p-4">
                    <p class="text-sm text-gray-400">Connected Wallet</p>
                    <p id="wallet-address" class="text-lg font-mono text-primary-gold truncate"></p>
                    <p id="wallet-balance" class="text-sm text-gray-300 mt-2"></p>
                </div>

                <button id="connect-wallet-btn" class="w-full bg-primary-gold text-primary-dark font-bold py-3 rounded-lg text-lg shadow-lg hover:bg-yellow-400 transition flex items-center justify-center gap-2">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M21.6 8.2l-2-3.5-2.2.3c-.4-.3-.8-.6-1.2-.8l-.5-2.2h-3.9l-.5 2.2c-.4.2-.8.5-1.2.8l-2.2-.3-2 3.5 1.7 1.3c-.1.3-.1.6-.1.9s0 .6.1.9l-1.7 1.3 2 3.5 2.2-.3c.4.3.8.6 1.2.8l.5 2.2h3.9l.5-2.2c.4-.2.8-.5 1.2-.8l-2.2.3 2-3.5-1.7-1.3c.1-.3.1-.6.1-.9s0-.6-.1-.9l1.7-1.3zM12 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>
                    Connect Wallet (MetaMask)
                </button>

                <button id="enter-app-btn" class="hidden w-full bg-transparent border-2 border-primary-gold text-primary-gold font-bold py-3 rounded-lg text-lg hover:bg-primary-gold hover:text-primary-dark transition">
                    Enter StayFi App →
                </button>
            </div>

            <div class="text-center pb-4 animate-fade-in">
                <p class="text-xs text-gray-500">Powered by Celo Network</p>
                <p id="network-status" class="text-xs text-gray-400 mt-1"></p>
            </div>
        </div>

        <!-- Main App Screen -->
        <div id="screen-main" class="screen hidden absolute inset-0 bg-primary-bg p-6 pt-12 pb-24 overflow-y-auto no-scrollbar">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-primary-dark">Explore Night-Passes</h2>
                <button id="wallet-menu-btn" class="px-4 py-2 bg-primary-gold text-primary-dark rounded-lg font-medium text-sm">
                    <span id="short-address"></span>
                </button>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-lg font-bold text-primary-dark mb-4">🎯 Demo: Mint Your First Night-Pass</h3>
                <p class="text-gray-600 mb-4">Experience RWA minting on Celo blockchain</p>
                
                <div class="space-y-3 mb-4">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500">Hotel</span>
                        <span class="font-medium text-primary-dark">KyotoStay Hotel</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500">Check-in Date</span>
                        <span class="font-medium text-primary-dark">Dec 20, 2025</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500">Price</span>
                        <span class="font-bold text-lg text-primary-gold">0.1 ETH</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500">APY</span>
                        <span class="font-medium text-green-600">+5.4%</span>
                    </div>
                </div>

                <button id="mint-nft-btn" class="w-full bg-primary-gold text-primary-dark font-bold py-3 rounded-lg text-lg shadow-lg hover:bg-yellow-400 transition">
                    🎫 Mint Night-Pass NFT
                </button>
            </div>

            <div class="bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl shadow-lg p-6 text-white">
                <h3 class="text-lg font-bold mb-2">✨ Your NFT Collection</h3>
                <div id="nft-list" class="space-y-2">
                    <p class="text-sm opacity-90">No Night-Passes minted yet</p>
                </div>
            </div>
        </div>

        <!-- Loading Modal -->
        <div id="modal-loading" class="modal hidden fixed inset-0 w-[390px] h-[844px] m-auto z-50">
            <div class="absolute inset-0 bg-black/80 flex flex-col justify-center items-center text-center">
                <div class="spinner"></div>
                <h2 id="loading-title" class="text-2xl font-bold text-white mt-8">Processing...</h2>
                <p id="loading-message" class="text-gray-300 mt-2">Please wait...</p>
            </div>
        </div>

        <!-- Success Modal -->
        <div id="modal-success" class="modal hidden fixed inset-0 w-[390px] h-[844px] m-auto z-50">
            <div class="absolute inset-0 bg-black/70 flex flex-col justify-center items-center text-center p-8">
                <div class="bg-white rounded-2xl p-8 flex flex-col items-center animate-fade-in max-w-sm">
                    <svg class="w-20 h-20 text-green-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <h2 class="text-2xl font-bold text-primary-dark mb-2">Success!</h2>
                    <p id="success-message" class="text-gray-600 mb-6">Transaction completed successfully</p>
                    <button id="close-success-btn" class="w-full bg-primary-gold text-primary-dark font-bold py-3 rounded-lg text-lg">
                        Awesome!
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing app...');
            
        // ===== Web3 Configuration =====
        const CONFIG = {
            // Local Hardhat Network
            CHAIN_ID: '0x7A69', // 31337
            CHAIN_NAME: 'Localhost Hardhat',
            RPC_URL: 'http://127.0.0.1:8545',
            EXPLORER: 'http://localhost:8545',
            CURRENCY: {
                name: 'ETH',
                symbol: 'ETH',
                decimals: 18
            },
            // Deployed contract addresses (Local)
            CONTRACTS: {
                NIGHT_PASS_NFT: '0xCf7Ed3AccA5a467e9e704C703E8D87F634fB0Fc9', // Deployed on Local Hardhat
                MARKETPLACE: '0xDc64a140Aa3E981100a9becA4E685f962f0cF6C9'      // Deployed on Local Hardhat
            }
        };

        // ===== Global State =====
        let provider = null;
        let signer = null;
        let userAddress = null;
        let nftContract = null;

        // ===== Contract ABIs (simplified) =====
        const NIGHT_PASS_ABI = [
            "function mintNightPass(address to, string hotelName, uint256 checkInDate, uint256 price, uint256 yieldPercent, string tokenURI) payable returns (uint256)",
            "function balanceOf(address owner) view returns (uint256)",
            "function tokenOfOwnerByIndex(address owner, uint256 index) view returns (uint256)",
            "function getNightPass(uint256 tokenId) view returns (tuple(string hotelName, uint256 checkInDate, uint256 price, uint256 yield, bool isActive, bool isUsed))",
            "function updateCompliance(address user, bool isCompliant)",
            "function useNightPass(uint256 tokenId)",
            "event NightPassMinted(uint256 indexed tokenId, address indexed owner, string hotelName, uint256 price)"
        ];

        // ===== UI Elements =====
        const elements = {
            connectBtn: document.getElementById('connect-wallet-btn'),
            enterAppBtn: document.getElementById('enter-app-btn'),
            walletInfo: document.getElementById('wallet-info'),
            walletAddress: document.getElementById('wallet-address'),
            walletBalance: document.getElementById('wallet-balance'),
            networkStatus: document.getElementById('network-status'),
            screenWallet: document.getElementById('screen-wallet-connect'),
            screenMain: document.getElementById('screen-main'),
            mintBtn: document.getElementById('mint-nft-btn'),
            nftList: document.getElementById('nft-list'),
            shortAddress: document.getElementById('short-address'),
            modalLoading: document.getElementById('modal-loading'),
            loadingTitle: document.getElementById('loading-title'),
            loadingMessage: document.getElementById('loading-message'),
            modalSuccess: document.getElementById('modal-success'),
            successMessage: document.getElementById('success-message'),
            closeSuccessBtn: document.getElementById('close-success-btn')
        };

        // ===== Wallet Connection =====
        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    alert('Please install MetaMask to use this app!\n\nGet it at: https://metamask.io');
                    return;
                }

                showLoading('Connecting Wallet...', 'Please approve the connection request');

                // Request account access
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                provider = new window.ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();

                // Check network
                const network = await provider.getNetwork();
                if (network.chainId !== parseInt(CONFIG.CHAIN_ID)) {
                    await switchNetwork();
                }

                // Get balance
                const balance = await provider.getBalance(userAddress);
                const balanceInEth = window.ethers.utils.formatEther(balance);

                // Update UI
                elements.walletAddress.textContent = userAddress;
                elements.walletBalance.textContent = `Balance: ${parseFloat(balanceInEth).toFixed(4)} ETH`;
                elements.shortAddress.textContent = `${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
                elements.walletInfo.classList.remove('hidden');
                elements.connectBtn.classList.add('hidden');
                elements.enterAppBtn.classList.remove('hidden');
                elements.networkStatus.textContent = `✅ Connected to ${CONFIG.CHAIN_NAME}`;

                hideLoading();
                console.log('✅ Wallet connected:', userAddress);

            } catch (error) {
                hideLoading();
                console.error('❌ Wallet connection error:', error);
                alert('Failed to connect wallet: ' + error.message);
            }
        }

        async function switchNetwork() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: CONFIG.CHAIN_ID }],
                });
            } catch (switchError) {
                // Network not added, try to add it
                if (switchError.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: CONFIG.CHAIN_ID,
                                chainName: CONFIG.CHAIN_NAME,
                                nativeCurrency: CONFIG.CURRENCY,
                                rpcUrls: [CONFIG.RPC_URL],
                                blockExplorerUrls: [CONFIG.EXPLORER]
                            }]
                        });
                    } catch (addError) {
                        throw new Error('Failed to add Celo network');
                    }
                } else {
                    throw switchError;
                }
            }
        }

        // ===== Contract Interactions =====
        async function mintNightPass() {
            try {
                if (!signer) {
                    alert('Please connect your wallet first');
                    return;
                }

                // Check if contract address is set
                if (CONFIG.CONTRACTS.NIGHT_PASS_NFT === '0x0000000000000000000000000000000000000000') {
                    alert('⚠️ Demo Mode: Contracts not deployed yet!\n\nTo enable real minting:\n1. Deploy contracts using Hardhat\n2. Update contract addresses in CONFIG\n3. Try again');
                    
                    // Show demo success
                    showLoading('Simulating Mint...', 'This is a demo transaction');
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    hideLoading();
                    showSuccess('Demo NFT Minted! 🎉', 'In production, this would mint a real NFT on Celo blockchain');
                    return;
                }

                showLoading('Minting Night-Pass NFT...', 'Please confirm transaction in your wallet');

                // Initialize contract
                nftContract = new window.ethers.Contract(
                    CONFIG.CONTRACTS.NIGHT_PASS_NFT,
                    NIGHT_PASS_ABI,
                    signer
                );

                // Mint parameters
                const hotelName = "KyotoStay Hotel";
                const checkInDate = Math.floor(new Date('2025-12-20').getTime() / 1000);
                const price = ethers.utils.parseUnits('120', 6); // 120 USDC (6 decimals)
                const yieldPercent = 540; // 5.4%
                const tokenURI = "ipfs://QmExample..."; // In production, upload to IPFS first

                // Send transaction
                const tx = await nftContract.mintNightPass(
                    userAddress,
                    hotelName,
                    checkInDate,
                    price,
                    yieldPercent,
                    tokenURI,
                    { value: ethers.utils.parseEther('0.1') } // 0.1 ETH
                );

                elements.loadingMessage.textContent = 'Waiting for confirmation...';
                await tx.wait();

                hideLoading();
                showSuccess('Night-Pass Minted! 🎉', `Transaction: ${tx.hash.slice(0, 10)}...`);
                
                // Refresh NFT list
                await loadUserNFTs();

            } catch (error) {
                hideLoading();
                console.error('❌ Mint error:', error);
                alert('Minting failed: ' + (error.message || 'Unknown error'));
            }
        }

        async function loadUserNFTs() {
            try {
                if (!nftContract || !userAddress) return;

                const balance = await nftContract.balanceOf(userAddress);
                
                if (balance.toNumber() === 0) {
                    elements.nftList.innerHTML = '<p class="text-sm opacity-90">No Night-Passes minted yet</p>';
                    return;
                }

                let html = '';
                for (let i = 0; i < balance.toNumber(); i++) {
                    const tokenId = await nftContract.tokenOfOwnerByIndex(userAddress, i);
                    const nightPass = await nftContract.getNightPass(tokenId);
                    
                    html += `
                        <div class="bg-white/20 rounded-lg p-3">
                            <p class="font-bold">${nightPass.hotelName}</p>
                            <p class="text-sm opacity-90">Token ID: #${tokenId.toString()}</p>
                        </div>
                    `;
                }
                
                elements.nftList.innerHTML = html;

            } catch (error) {
                console.error('Error loading NFTs:', error);
            }
        }

        // ===== UI Helpers =====
        function showLoading(title, message) {
            elements.loadingTitle.textContent = title;
            elements.loadingMessage.textContent = message;
            elements.modalLoading.classList.remove('hidden');
        }

        function hideLoading() {
            elements.modalLoading.classList.add('hidden');
        }

        function showSuccess(title, message) {
            elements.successMessage.textContent = message;
            elements.modalSuccess.querySelector('h2').textContent = title;
            elements.modalSuccess.classList.remove('hidden');
        }

        function hideSuccess() {
            elements.modalSuccess.classList.add('hidden');
        }

        function enterApp() {
            elements.screenWallet.classList.add('hidden');
            elements.screenMain.classList.remove('hidden');
            loadUserNFTs();
        }

        // ===== Event Listeners =====
        console.log('Setting up event listeners...');
        console.log('Connect button:', elements.connectBtn);
        
        elements.connectBtn.addEventListener('click', function() {
            console.log('Connect button clicked!');
            connectWallet();
        });
        
        elements.enterAppBtn.addEventListener('click', function() {
            console.log('Enter app button clicked!');
            enterApp();
        });
        
        elements.mintBtn.addEventListener('click', function() {
            console.log('Mint button clicked!');
            mintNightPass();
        });
        
        elements.closeSuccessBtn.addEventListener('click', function() {
            console.log('Close success button clicked!');
            hideSuccess();
        });

        // Listen for account changes
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    location.reload();
                } else {
                    connectWallet();
                }
            });

            window.ethereum.on('chainChanged', () => {
                location.reload();
            });
        }

        console.log('🚀 StayFi Web3 App Loaded');
        console.log('📍 Network:', CONFIG.CHAIN_NAME);
        console.log('💡 Tip: Make sure you have ETH in your local Hardhat wallet!');
        
        }); // End DOMContentLoaded
    </script>

</body>
</html>
